name: CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  quality:
    name: Quality (py${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11", "3.12"]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e ".[dev]"

      - name: Lint
        run: ruff check .

      - name: Type check
        run: mypy pp

      - name: Unit tests
        run: python -m unittest discover -s tests -v

  container-smoke:
    name: Container smoke
    runs-on: ubuntu-latest
    needs: quality

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install package
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e .

      - name: Detect Docker daemon
        id: docker
        run: |
          if docker info >/dev/null 2>&1; then
            echo "available=true" >> "$GITHUB_OUTPUT"
          else
            echo "available=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Run container backend smoke
        if: steps.docker.outputs.available == 'true'
        run: |
          cat > /tmp/pp_container_policy.json <<'JSON'
          {
            "proof_targets": [
              {"name": "smoke", "cmd": "true"}
            ],
            "policy": {
              "network": "deny",
              "allowed_commands": ["true"],
              "write_allowlist": ["**"],
              "deny_write": [],
              "limits": {
                "max_attempts": 1,
                "max_files_changed": 8,
                "max_patch_bytes": 200000,
                "per_command_timeout_sec": 120
              },
              "minimize": false,
              "sandbox": {
                "backend": "container",
                "container_runtime": "docker",
                "container_image": "busybox:1.36",
                "container_workdir": "/workspace",
                "cpu_limit": null,
                "memory_limit": null
              },
              "attestation": {
                "enabled": false,
                "mode": "none",
                "key_env": "PP_ATTEST_HMAC_KEY"
              }
            }
          }
          JSON
          python -m pp.cli prove --policy /tmp/pp_container_policy.json

      - name: Skip container smoke (docker unavailable)
        if: steps.docker.outputs.available != 'true'
        run: echo "Docker daemon unavailable; container smoke skipped."
